# Neuropixels Toolkit User Documentation

## Set up environment
1. Create a virtual env for later use
2. Install Matlab 
    - Matlab essentials
    - Image Processing Toolbox
    - Signal Processing Toolbox
    - Parallel Computing Toolbox
    - Stat & machine learning Toolbox
    - Install MATLAB Python API, find `C:\Program Files\MATLAB\R2021a\extern\engines\python`, run `python setup.py install`
3. Download CatGT, TPrime and C_Waves[here](http://billkarsh.github.io/SpikeGLX/#command-line-tool-installation)
    - For Linux:
        - CatGT, TPrime, C_Waves need to call `bash install.sh`
4. Download Kilosort3.0/2.5/2.0 [here](https://github.com/MouseLand/Kilosort)
    - run `CUDA/mexGPUall` in MATLAB (need to run for each version)
5. `git clone git@github.com:kwikteam/npy-matlab.git`
6. `git clone git@github.com:vathes/ecephys_spike_sorting.git`
    - pip install .
    - There are few python packages that needs to downgrade/install
        - argschema==1.*
        - marshmallow==2.*
        - pip install h5py
        - pip install python-dotenv
7. Set up NVIDIA driver and CUDA toolkit for KiloSort
    - nvidia driver
        - The version of NVIDIA driver has to match with your GPU, find the version: https://www.nvidia.com/Download/index.aspx?lang=en-us
        - install: https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html#runfile
    - cuda toolkit
        - The version of CUDA toolkit has to match with your nvidia driver version and your MATLAB version. In this case, it uses nvidia driver version 450.142.00 and MATLAB R2021b with CUDA 11.0, install:https://developer.nvidia.com/cuda-11.0-download-archive?target_os=Linux&target_arch=x86_64&target_distro=Ubuntu&target_version=2004&target_type=runfilelocal
    - might need to downgrade gcc to 8.*
    ```
    cd /usr/bin
    sudo rm gcc
    sudo ln -s gcc-8 gcc
    sudo rm g++
    sudo ln -s g++-8 g++
    ```

## Set up input dataset and config file
The example input data directory structure:
```
data_for_ecephys
├── kilosort_datatemp
└── subject1_session1
│   ├── SC011_021919_g0(un-concatenated data, CatGT's input)
│   │   ├── SC011_021919_g0_imec0
│   │   ├── SC011_021919_g0_imec1
│   │   ├── SC011_021919_g0_imec2
│   │   ├── SC011_021919_g0_t0.nidq.bin
│   │   └── SC011_021919_g0_t0.nidq.meta
│   ├── catgt_SC011_021919_g0(CatGT result directory, KiloSort's input)
│   │   ├── SC011_021919_g0_imec0
│   │   │   ├── imec0_ks3.0(KiloSort result directory)
│   │   │   ├── SC011_021919_g0_tcat.imec0.ap.bin(concatenated datafile for kilosort)
│   │   │   ├── SC011_021919_g0_tcat.imec0.ap.meta(concatenated metadata for kilosort)
│   │   │   └── SC011_021919_g0_tcat.imec0.ap_chanMap.mat(channel map)
│   │   ├── SC011_021919_g0_imec1
│   │   │   ├── imec1_ks3.0
│   │   │   ├── SC011_021919_g0_tcat.imec1.ap.bin
│   │   │   ├── SC011_021919_g0_tcat.imec1.ap.meta
│   │   │   └── SC011_021919_g0_tcat.imec1.ap_chanMap.mat
│   │   └── SC011_021919_g0_imec2
│   │   │   ├── imec2_ks3.0
│   │   │   ├── SC011_021919_g0_tcat.imec2.ap.bin
│   │   │   ├── SC011_021919_g0_tcat.imec2.ap.meta
│   │   │   └── SC011_021919_g0_tcat.imec2.ap_chanMap.mat
```

This needs to match with your config file:
```
{
    "pipeline": {
        "data": {
            "rootDataDir": "/home/ubuntu/neuropixel/data_for_ecephys",
            "dataDir": "subject1_session1",
            "spikeGLXData": "true",
            "runName": "SC011_021919",
            "gateIdx": "0",
            "probes": "0,1,2",
        }
    }
}

# The pattern is:
rootDataDir
    dataDir
        runName+"_g"+gateIdx                      ->  Source data dir
            runName+"_g"+gateIdx+"_imec"+probes   ->  Per probe data dir
        "catgt_"+runName+"_g"+gateIdx             ->  Concatenated data dir
            runName+"_g"+gateIdx+"_imec"+probes   ->  Per prober concatenated data dir
                "imec"+gateIdx+"_ks"+KSVer        ->  Kilosort result dir
```
> Note: The full example config is in ~/neuropixels_toolkit/configs/test_config.json

## Execute your first pipeline

>Please check `~/neuropixels_toolkit/example/live_script.mlx` or `~/neuropixels_toolkit/test.m`.
The result data files(.npy) that used for plotting in the live script are generated by KiloSort in `imec[Gate]_ks[KSver](KiloSort result)` directory.
